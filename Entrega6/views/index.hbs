<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <script src="./socket.io/socket.io.js"></script>
    <title>Entrega 6 socketChat</title>
</head>

<body class="bg-dark">
    <div class="container mt-3">
        <div class="jumbotron bg-dark">
            {{{body}}}
            {{!-- <h1 class="text-light text-center">Ingrese los datos del producto</h1>
            <br>
            <form action="/" method="post" id="form_prod">
                <div class="form-group">
                    <label for="id"><b class="text-light">ID</b></label>
                    <input id="id" class="form-control bg-dark text-light" type="number" name="id" required>
                </div>
                <div class="form-group">
                    <label for="name"><b class="text-light">Name</b></label>
                    <input id="prod_name" class="form-control bg-dark text-light" type="text" name="name" required>
                </div>

                <div class="form-group">
                    <label for="price"><b class="text-light">Price</b></label>
                    <input id="price" class="form-control bg-dark text-light" type="number" name="price" required>
                </div>

                <div class="form-group">
                    <label for="src"><b class="text-light">SRC</b></label>
                    <input id="src" class="form-control bg-dark text-light" type="text" name="src" required>
                </div>
                <div class="d-flex justify-content-center">
                    <button class="btn_prod btn-outline-light mt-3 mb-5">Enviar</button>
                </div>
            </form>

            <h2 class="text-light m-3 me-auto">Productos</h2>
            <br>
            {{#if length}}
            <div class="table-responsive">
                <table class="table table-dark">
                    <tr>
                        <th class="text-center text-light">ID</th>
                        <th class="text-center text-light">Nombre</th>
                        <th class="text-center text-light">Precio</th>
                    </tr>
                    {{#each productos}}
                    <tr>
                        <td class="text-center text-light">{{this.id}}</td>
                        <td class="text-center text-light">{{this.name}}</td>
                        <td class="text-center text-light">{{this.price}}</td>
                    </tr>
                    {{/each}}
                </table>
            </div>
            {{/if}}
        </div> --}}

        <div class="p-2 border my-5">
            <h1 class="text-light text-center">Centro de Mensajes</h1>
            <br>
            <div id="container_chat">


                <form id="data_user">
                    <div class="form-group">
                        <label for="email"><b class="text-light mb-3">Email</b></label>
                        <input id="email_user" class="form-control bg-dark text-light mb-3" type="email"
                            name="email_user" placeholder="Email" required>
                        <input class="btn_submit" type="submit" value="Ingresar al chat">
                    </div>
                </form>
            </div>
            <div>
                <div>
                    <div>
                        <input type="text" name="inputtext" id="inputtext" placeholder="Ingresa tu mensaje">
                        <button id="send_socket">Enviar</button>
                        <p id="parrafochat">
                        </p>
                    </div>
                    {{!-- <div class="users">
                        Hacer despues...
                    </div> --}}
                </div>
            </div>
        </div>
    </div>
    {{!-- <a href="./productos"><button class="btn btn-outline-light mt-2">Ir a lista de productos</button></a>
    --}}


    <script>
        let prod = null;
        let prod_name = document.getElementById("prod_name");
        let price = document.getElementById("price");
        let src = document.getElementById("src");
        let form_prod = document.getElementById("form_prod");
        form_prod.addEventListener("submit", evt => {
            evt.preventDefault();
            prod = {
                name: evt.target[1].value,
                price: evt.target[2].value,
                src: evt.target[3].value
            }
            socket = io();
            socket.emit("addProd", prod)
            loadProd()
        })

        function loadProd() {
            socket.on("loadProd", data => { console.log(data) })
        }


        let socket = null;
        let chat_user = null;
        let inputtext = document.getElementById("inputtext");
        let send_socket = document.getElementById("send_socket");
        let container_chat = document.getElementById("container_chat");
        let parrafochat = document.getElementById("parrafochat");
        let form_data_user = document.getElementById("data_user");
        form_data_user.addEventListener("submit", evt => {
            evt.preventDefault();
            chat_user = {
                email: evt.target[0].value
            }
            if (chat_user == "") window.location.reload();
            socket = io();
            socket.emit("addUser", chat_user);
            container_chat.classList = "active";
            readSockets();
        });


        function readSockets() {
            loadChat();
            socket.on("listenserver", data => {
                console.log("Recibiendo..", data);
                loadData(data);
            });
        }

        function loadChat() {
            socket.on("init", data => {
                loadData(data);
            })
            socket.on("loadUsers", data => {
                console.log("Evento loadUsers --> ", data);
            })
        }

        function loadData(data) {
            let innerP = ``;
            data.forEach(element => {
                innerP += `<b>${element.email} </b><b>${new Date()}</b> ${element.sms} </br>`;
            });
            parrafochat.innerHTML = innerP;
        }

        send_socket.addEventListener("click", evt => {
            let sendMessage = {
                ...chat_user,
                sms: inputtext.value
            }
            socket.emit("mensaje", sendMessage);
            inputtext.value = "";
        });
    </script>
</body>

</html>